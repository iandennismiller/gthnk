#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# gthnk (c) Ian Dennis Miller

import sys
import os
import glob

from flask_script import Manager, Shell, Server
from flask_migrate import Migrate, MigrateCommand
import alembic
import alembic.config

from sqlalchemy.exc import OperationalError

from gthnk import db
from gthnk.__meta__ import __version__
from gthnk.server import create_app
from gthnk.models.user import User
from gthnk.models.day import Day
from gthnk.models.entry import Entry
from gthnk.models.page import Page
from gthnk.adaptors.journal_buffer import TextFileJournalBuffer
from gthnk.librarian import Librarian
from gthnk.integrations import make_config, write_config_file


app = create_app()
migrate = Migrate(app, db, directory="src/gthnk/migrations")


def _make_context():
    return {
        "app": app,
        "db": db,
    }

manager = Manager(app)
manager.add_command("shell", Shell(make_context=_make_context))
manager.add_command('db', MigrateCommand)


@manager.option('-d', '--directory', help='directory', required=True)
def import_archive(directory):
    """
    Import archive of journal files
    """
    with app.app_context():
        journal_buffer = TextFileJournalBuffer()
        match_str = os.path.join(directory, "*.txt")
        journal_buffer.process_list(glob.glob(match_str))
        journal_buffer.save_entries()

@manager.command
def journal_export():
    """
    Export journal files
    """
    with app.app_context():
        librarian = Librarian(app)
        librarian.export_journal()

@manager.command
def journal_rotate():
    """
    Rotate journal files
    """
    with app.app_context():
        librarian = Librarian(app)
        librarian.rotate_buffers()

@manager.command
def gui():
    """
    drop all databases
    """
    import webview
    webview.create_window('gthnk', 'http://localhost:1620')
    webview.start()

if __name__ == "__main__":
    manager.run()
